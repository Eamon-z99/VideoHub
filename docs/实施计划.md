# VideoHub è§†é¢‘å­˜å‚¨ä¸æ’­æ”¾ç³»ç»Ÿ - å®æ–½è®¡åˆ’

> åŸºäºå½“å‰é¡¹ç›®çŠ¶æ€ï¼ŒæŒ‰ä¼˜å…ˆçº§è§„åˆ’çš„è¯¦ç»†å®æ–½æ­¥éª¤

---

## ğŸ“Š å½“å‰é¡¹ç›®çŠ¶æ€åˆ†æ

### âœ… å·²å®Œæˆ
- [x] åç«¯åŸºç¡€ playurl æ¥å£ï¼ˆç¡¬ç¼–ç  2 ä¸ªè§†é¢‘ï¼‰
- [x] å‰ç«¯åŸºç¡€ MSE æ’­æ”¾å™¨ï¼ˆèƒ½æ’­å•ä¸ª m4sï¼‰
- [x] æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£
- [x] æœ¬åœ°æœ‰ Bç«™ä¸‹è½½çš„åˆ†ç‰‡æ–‡ä»¶æ ·æœ¬

### âŒ å¾…å®Œå–„
- [ ] åç«¯ï¼šplayurl æ¥å£ä»æ–‡ä»¶ç³»ç»Ÿ/æ•°æ®åº“è¯»å– manifest
- [ ] åç«¯ï¼šæ”¯æŒå¤šæ¸…æ™°åº¦ manifest
- [ ] åç«¯ï¼šé™æ€æ–‡ä»¶æœåŠ¡ï¼ˆæ˜ å°„ Eç›˜åˆ†ç‰‡æ–‡ä»¶ï¼‰
- [ ] å‰ç«¯ï¼šMSE æ’­æ”¾å™¨æ”¯æŒå¤šåˆ†ç‰‡é¡ºåºæ’­æ”¾
- [ ] å‰ç«¯ï¼šæ¸…æ™°åº¦åˆ‡æ¢ UI
- [ ] è½¬ç æœåŠ¡ï¼šmp4 â†’ å¤šæ¸…æ™°åº¦åˆ†ç‰‡

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§ï¼ˆæ¨èé¡ºåºï¼‰

### é˜¶æ®µä¸€ï¼šåç«¯åŸºç¡€è®¾æ–½ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ï¼‰

**ç›®æ ‡**ï¼šè®©åç«¯èƒ½å¤ŸåŠ¨æ€è¯»å– manifestï¼Œæ”¯æŒä»»æ„è§†é¢‘æ’­æ”¾

#### Step 1.1ï¼šå®Œå–„ playurl æ¥å£ - ä»æ–‡ä»¶ç³»ç»Ÿè¯»å– manifest

**åšä»€ä¹ˆï¼š**
- ä¿®æ”¹ `PlayurlController`ï¼Œä¸å†ç¡¬ç¼–ç  manifest
- ä» `E:\BiliDownload\{cid}\videoInfo.json` è¯»å–è§†é¢‘ä¿¡æ¯
- ä» `E:\BiliDownload\{cid}\.playurl` è¯»å– Bç«™åŸå§‹ playurlï¼ˆæˆ–è‡ªå·±ç”Ÿæˆç®€åŒ– manifestï¼‰
- è¿”å›åŠ¨æ€ manifest

**æŠ€æœ¯ç‚¹ï¼š**
- Spring Boot `@Value` é…ç½®å­˜å‚¨æ ¹è·¯å¾„
- `Files.readString()` è¯»å– JSON
- Jackson è§£æ JSON

**é¢„æœŸäº§å‡ºï¼š**
- è®¿é—® `/playurl/33095614562` èƒ½è¿”å›åŠ¨æ€ manifest
- æ”¯æŒä»»æ„ cidï¼ˆåªè¦ Eç›˜æœ‰å¯¹åº”ç›®å½•ï¼‰

**é¢„è®¡æ—¶é—´ï¼š** 1-2 å°æ—¶

---

#### Step 1.2ï¼šé™æ€æ–‡ä»¶æœåŠ¡ - æ˜ å°„ Eç›˜åˆ†ç‰‡æ–‡ä»¶

**åšä»€ä¹ˆï¼š**
- é…ç½® Spring Boot é™æ€èµ„æºæ˜ å°„
- `/mse/**` â†’ `E:\BiliDownload\**`
- è®©å‰ç«¯èƒ½é€šè¿‡ `/api/mse/{cid}/{filename}.m4s` è®¿é—®åˆ†ç‰‡

**æŠ€æœ¯ç‚¹ï¼š**
- `WebMvcConfigurer.addResourceHandlers()`
- Windows è·¯å¾„å¤„ç†

**é¢„æœŸäº§å‡ºï¼š**
- `http://localhost:8081/mse/33095614562/33095614562-1-30080.m4s` èƒ½ç›´æ¥è®¿é—®æ–‡ä»¶

**é¢„è®¡æ—¶é—´ï¼š** 30 åˆ†é’Ÿ

---

#### Step 1.3ï¼šManifest ç”ŸæˆæœåŠ¡ - æ ¹æ®ç›®å½•ç»“æ„ç”Ÿæˆ manifest

**åšä»€ä¹ˆï¼š**
- æ‰«æ `E:\BiliDownload\{cid}\` ç›®å½•
- è‡ªåŠ¨è¯†åˆ« `*-30080.m4s`ï¼ˆè§†é¢‘ï¼‰ã€`*-30280.m4s`ï¼ˆéŸ³é¢‘ï¼‰
- ç”¨ `ffprobe` æå–åˆ†è¾¨ç‡ã€ç ç‡ã€codec ä¿¡æ¯
- ç”Ÿæˆæ ‡å‡† `MseManifest` JSON

**æŠ€æœ¯ç‚¹ï¼š**
- `Files.list()` æ‰«æç›®å½•
- `ProcessBuilder` è°ƒç”¨ `ffprobe`
- JSON è§£æå’Œæ„å»º

**é¢„æœŸäº§å‡ºï¼š**
- æ–°å¢è§†é¢‘åˆ° Eç›˜åï¼Œplayurl æ¥å£è‡ªåŠ¨è¯†åˆ«å¹¶è¿”å› manifest

**é¢„è®¡æ—¶é—´ï¼š** 2-3 å°æ—¶

---

### é˜¶æ®µäºŒï¼šå‰ç«¯æ’­æ”¾å™¨å¢å¼ºï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­ï¼‰

**ç›®æ ‡**ï¼šè®©æ’­æ”¾å™¨æ”¯æŒå¤šåˆ†ç‰‡ã€æ¸…æ™°åº¦åˆ‡æ¢

#### Step 2.1ï¼šMSE æ’­æ”¾å™¨ - æ”¯æŒå¤šåˆ†ç‰‡é¡ºåºæ’­æ”¾

**åšä»€ä¹ˆï¼š**
- ä¿®æ”¹ `initMsePlayer`ï¼Œä¸å†åªæ’­ `segments[0]`
- æŒ‰ manifest çš„ `segments` æ•°ç»„é¡ºåºï¼Œä¾æ¬¡ fetch + appendBuffer
- å®ç°é¢„åŠ è½½ï¼šæå‰åŠ è½½ä¸‹ä¸€ä¸ªåˆ†ç‰‡
- å¤„ç† `SourceBuffer` æ»¡çš„æƒ…å†µï¼ˆremove æ—§æ•°æ®ï¼‰

**æŠ€æœ¯ç‚¹ï¼š**
- MSE `SourceBuffer.appendBuffer()` é¡ºåºæ§åˆ¶
- `SourceBuffer.remove()` æ¸…ç†æ—§æ•°æ®
- `video.timeupdate` ç›‘å¬ï¼Œè®¡ç®—å½“å‰åˆ†ç‰‡ index

**é¢„æœŸäº§å‡ºï¼š**
- æ’­æ”¾å™¨èƒ½æµç•…æ’­æ”¾å¤šä¸ªåˆ†ç‰‡ç»„æˆçš„å®Œæ•´è§†é¢‘
- æ”¯æŒæ‹–åŠ¨è¿›åº¦æ¡ï¼ˆè·³åˆ°å¯¹åº”åˆ†ç‰‡ï¼‰

**é¢„è®¡æ—¶é—´ï¼š** 3-4 å°æ—¶

---

#### Step 2.2ï¼šæ¸…æ™°åº¦åˆ‡æ¢ UI

**åšä»€ä¹ˆï¼š**
- åœ¨æ’­æ”¾å™¨ä¸‹æ–¹æ·»åŠ æ¸…æ™°åº¦é€‰æ‹©æŒ‰é’®ï¼ˆ480P/720P/1080Pï¼‰
- ç‚¹å‡»åˆ‡æ¢æ—¶ï¼Œè°ƒç”¨æ–°çš„ `video` è½¨çš„ baseUrl
- é‡æ–°åˆ›å»º `SourceBuffer`ï¼Œä»å½“å‰æ’­æ”¾æ—¶é—´ç‚¹ç»§ç»­

**æŠ€æœ¯ç‚¹ï¼š**
- Element Plus `el-select` æˆ– `el-button-group`
- MSE åˆ‡æ¢è½¨é“é€»è¾‘
- æ—¶é—´åŒæ­¥ï¼ˆåˆ‡æ¢åä»ç›¸åŒæ—¶é—´ç‚¹ç»§ç»­ï¼‰

**é¢„æœŸäº§å‡ºï¼š**
- ç”¨æˆ·èƒ½çœ‹åˆ°æ¸…æ™°åº¦é€‰æ‹©å™¨
- ç‚¹å‡»åˆ‡æ¢åè§†é¢‘æ— ç¼åˆ‡æ¢æ¸…æ™°åº¦

**é¢„è®¡æ—¶é—´ï¼š** 2-3 å°æ—¶

---

### é˜¶æ®µä¸‰ï¼šè½¬ç æœåŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­ï¼‰

**ç›®æ ‡**ï¼šå®ç° mp4 â†’ å¤šæ¸…æ™°åº¦åˆ†ç‰‡çš„è‡ªåŠ¨åŒ–æµç¨‹

#### Step 3.1ï¼šè½¬ç ä»»åŠ¡æ¥å£

**åšä»€ä¹ˆï¼š**
- åˆ›å»º `/api/transcode` æ¥å£
- æ¥æ”¶ mp4 æ–‡ä»¶è·¯å¾„æˆ–ä¸Šä¼ æ–‡ä»¶
- åˆ›å»ºè½¬ç ä»»åŠ¡ï¼ˆæ•°æ®åº“è®°å½•ï¼‰
- è¿”å› taskId

**æŠ€æœ¯ç‚¹ï¼š**
- Spring Boot æ–‡ä»¶ä¸Šä¼ 
- æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆtask_id, source_path, status, progressï¼‰
- å¼‚æ­¥ä»»åŠ¡ `@Async`

**é¢„æœŸäº§å‡ºï¼š**
- èƒ½æäº¤è½¬ç ä»»åŠ¡
- ä»»åŠ¡çŠ¶æ€å¯æŸ¥è¯¢

**é¢„è®¡æ—¶é—´ï¼š** 2 å°æ—¶

---

#### Step 3.2ï¼šFFmpeg è½¬ç æœåŠ¡

**åšä»€ä¹ˆï¼š**
- å®ç°è½¬ç é€»è¾‘ï¼šè°ƒç”¨ FFmpeg å‘½ä»¤è¡Œ
- å¤šæ¸…æ™°åº¦å¹¶è¡Œè½¬ç ï¼ˆ480P/720P/1080Pï¼‰
- ç”Ÿæˆåˆ†ç‰‡æ–‡ä»¶ï¼ˆseg-0001.m4s, seg-0002.m4s...ï¼‰
- ç”Ÿæˆ manifest.json
- æ›´æ–°ä»»åŠ¡çŠ¶æ€

**æŠ€æœ¯ç‚¹ï¼š**
- `ProcessBuilder` è°ƒç”¨ FFmpeg
- FFmpeg å¤šæ¸…æ™°åº¦å‘½ä»¤
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆåˆ›å»ºç›®å½•ã€ç§»åŠ¨æ–‡ä»¶ï¼‰

**é¢„æœŸäº§å‡ºï¼š**
- ä¸Šä¼ ä¸€ä¸ª mp4ï¼Œè‡ªåŠ¨è½¬æˆå¤šæ¸…æ™°åº¦åˆ†ç‰‡
- è½¬ç å®Œæˆåè‡ªåŠ¨ç”Ÿæˆ manifest

**é¢„è®¡æ—¶é—´ï¼š** 4-5 å°æ—¶

---

## ğŸ“… æ¨èå®æ–½é¡ºåºï¼ˆæŒ‰å‘¨ï¼‰

### ç¬¬ 1 å‘¨ï¼šåç«¯åŸºç¡€è®¾æ–½

**Day 1-2ï¼š**
- âœ… Step 1.1ï¼šå®Œå–„ playurl æ¥å£ï¼ˆä»æ–‡ä»¶ç³»ç»Ÿè¯»å–ï¼‰
- âœ… Step 1.2ï¼šé™æ€æ–‡ä»¶æœåŠ¡æ˜ å°„

**Day 3-4ï¼š**
- âœ… Step 1.3ï¼šManifest ç”ŸæˆæœåŠ¡

**Day 5ï¼š**
- æµ‹è¯•ï¼šç¡®ä¿ä»»æ„è§†é¢‘éƒ½èƒ½é€šè¿‡ playurl æ’­æ”¾

---

### ç¬¬ 2 å‘¨ï¼šå‰ç«¯æ’­æ”¾å™¨

**Day 1-3ï¼š**
- âœ… Step 2.1ï¼šMSE å¤šåˆ†ç‰‡æ’­æ”¾

**Day 4-5ï¼š**
- âœ… Step 2.2ï¼šæ¸…æ™°åº¦åˆ‡æ¢ UI
- æµ‹è¯•ï¼šå®Œæ•´æ’­æ”¾ä½“éªŒ

---

### ç¬¬ 3 å‘¨ï¼šè½¬ç æœåŠ¡ï¼ˆå¯é€‰ï¼‰

**Day 1-2ï¼š**
- âœ… Step 3.1ï¼šè½¬ç ä»»åŠ¡æ¥å£

**Day 3-5ï¼š**
- âœ… Step 3.2ï¼šFFmpeg è½¬ç æœåŠ¡
- æµ‹è¯•ï¼šç«¯åˆ°ç«¯æµç¨‹ï¼ˆä¸Šä¼  â†’ è½¬ç  â†’ æ’­æ”¾ï¼‰

---

## ğŸš€ ç«‹å³å¼€å§‹ï¼šç¬¬ä¸€æ­¥è¯¦ç»†æŒ‡å—

### Step 1.1ï¼šå®Œå–„ playurl æ¥å£

#### 1. åˆ›å»ºé…ç½®ç±»

**æ–‡ä»¶ï¼š** `backend/VideoBackend/src/main/resources/application.properties`

```properties
# è§†é¢‘å­˜å‚¨æ ¹è·¯å¾„ï¼ˆWindowsï¼‰
video.storage.root=E:\\BiliDownload
```

#### 2. åˆ›å»º ManifestService

**æ–‡ä»¶ï¼š** `backend/VideoBackend/src/main/java/videobackend/video/service/ManifestService.java`

```java
@Service
public class ManifestService {
    
    @Value("${video.storage.root}")
    private String storageRoot;
    
    public MseManifest getManifest(String cid) throws IOException {
        Path videoDir = Paths.get(storageRoot, cid);
        Path videoInfoPath = videoDir.resolve("videoInfo.json");
        
        if (!Files.exists(videoInfoPath)) {
            return null;
        }
        
        // è¯»å– videoInfo.json
        String videoInfoJson = Files.readString(videoInfoPath);
        ObjectMapper mapper = new ObjectMapper();
        JsonNode videoInfo = mapper.readTree(videoInfoJson);
        
        // æ„å»º manifest
        MseManifest manifest = new MseManifest();
        manifest.setCid(cid);
        manifest.setDuration(videoInfo.get("duration").asLong());
        
        // æ‰«æç›®å½•ï¼Œæ‰¾åˆ° m4s æ–‡ä»¶
        List<MseManifest.Track> videoTracks = new ArrayList<>();
        List<MseManifest.Track> audioTracks = new ArrayList<>();
        
        Files.list(videoDir)
            .filter(p -> p.toString().endsWith(".m4s"))
            .forEach(m4sFile -> {
                String filename = m4sFile.getFileName().toString();
                // åˆ¤æ–­æ˜¯è§†é¢‘è¿˜æ˜¯éŸ³é¢‘ï¼ˆ30080=è§†é¢‘ï¼Œ30280=éŸ³é¢‘ï¼‰
                if (filename.contains("-30080.m4s")) {
                    MseManifest.Track track = new MseManifest.Track();
                    track.setId("v_30080");
                    track.setCodec("video/mp4; codecs=\"avc1.640028\"");
                    track.setBandwidth(1500_000L);
                    track.setSegments(Collections.singletonList(
                        "/mse/" + cid + "/" + filename
                    ));
                    videoTracks.add(track);
                } else if (filename.contains("-30280.m4s")) {
                    MseManifest.Track track = new MseManifest.Track();
                    track.setId("a_30280");
                    track.setCodec("audio/mp4; codecs=\"mp4a.40.2\"");
                    track.setBandwidth(128_000L);
                    track.setSegments(Collections.singletonList(
                        "/mse/" + cid + "/" + filename
                    ));
                    audioTracks.add(track);
                }
            });
        
        manifest.setVideo(videoTracks);
        manifest.setAudio(audioTracks);
        
        return manifest;
    }
}
```

#### 3. ä¿®æ”¹ PlayurlController

```java
@RestController
@RequestMapping
public class PlayurlController {
    
    @Autowired
    private ManifestService manifestService;
    
    @GetMapping("/playurl/{cid}")
    public ResponseEntity<MseManifest> getPlayurl(@PathVariable String cid) {
        try {
            MseManifest manifest = manifestService.getManifest(cid);
            if (manifest == null) {
                return ResponseEntity.notFound().build();
            }
            return ResponseEntity.ok(manifest);
        } catch (IOException e) {
            return ResponseEntity.status(500).build();
        }
    }
}
```

#### 4. é…ç½®é™æ€èµ„æºæ˜ å°„

**æ–‡ä»¶ï¼š** `backend/VideoBackend/src/main/java/videobackend/video/config/WebConfig.java`

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Value("${video.storage.root}")
    private String storageRoot;
    
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/mse/**")
                .addResourceLocations("file:" + storageRoot.replace("\\", "/") + "/");
    }
}
```

---

## âœ… å®Œæˆæ ‡å‡†

### Step 1.1 å®Œæˆæ ‡å‡†ï¼š
- [ ] è®¿é—® `http://localhost:8081/playurl/33095614562` è¿”å›åŠ¨æ€ manifest
- [ ] è®¿é—® `http://localhost:8081/mse/33095614562/33095614562-1-30080.m4s` èƒ½ä¸‹è½½æ–‡ä»¶
- [ ] å‰ç«¯æ’­æ”¾å™¨èƒ½æ­£å¸¸æ’­æ”¾

---

## ğŸ¯ å»ºè®®ï¼šå…ˆä»åç«¯å¼€å§‹

**ç†ç”±ï¼š**
1. **åç«¯æ˜¯åŸºç¡€**ï¼šæ²¡æœ‰å¥½çš„ manifest æ¥å£ï¼Œå‰ç«¯æ— æ³•æµ‹è¯•
2. **å¿«é€Ÿè§æ•ˆ**ï¼šStep 1.1 + 1.2 å®Œæˆåï¼Œä½ å°±èƒ½æ’­æ”¾ä»»æ„è§†é¢‘
3. **é£é™©ä½**ï¼šæ–‡ä»¶ç³»ç»Ÿè¯»å–æ¯” MSE æ’­æ”¾å™¨è°ƒè¯•æ›´ç®€å•

**ç¬¬ä¸€æ­¥è¡ŒåŠ¨ï¼š**
1. ç«‹å³å¼€å§‹ Step 1.1ï¼ˆå®Œå–„ playurl æ¥å£ï¼‰
2. å®Œæˆåæµ‹è¯•ï¼šç¡®ä¿èƒ½åŠ¨æ€è¯»å– manifest
3. ç„¶ååš Step 1.2ï¼ˆé™æ€æ–‡ä»¶æ˜ å°„ï¼‰
4. æœ€åå®Œå–„å‰ç«¯æ’­æ”¾å™¨

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Windows è·¯å¾„**ï¼šæ³¨æ„ `E:\BiliDownload` çš„è·¯å¾„åˆ†éš”ç¬¦å¤„ç†
2. **æ–‡ä»¶ç¼–ç **ï¼šJSON æ–‡ä»¶ç¡®ä¿ UTF-8
3. **é”™è¯¯å¤„ç†**ï¼šæ–‡ä»¶ä¸å­˜åœ¨ã€JSON è§£æå¤±è´¥è¦æœ‰å‹å¥½é”™è¯¯
4. **æ€§èƒ½**ï¼šmanifest ç”Ÿæˆå¯ä»¥åŠ ç¼“å­˜ï¼ˆRedisï¼‰

---

## ğŸ”„ è¿­ä»£å»ºè®®

- **ç¬¬ 1 ç‰ˆ**ï¼šå…ˆè®©ç°æœ‰ 2 ä¸ªè§†é¢‘èƒ½åŠ¨æ€è¯»å–ï¼ˆStep 1.1ï¼‰
- **ç¬¬ 2 ç‰ˆ**ï¼šæ”¯æŒä»»æ„æ–°è§†é¢‘ï¼ˆStep 1.3ï¼‰
- **ç¬¬ 3 ç‰ˆ**ï¼šå‰ç«¯å¤šåˆ†ç‰‡æ’­æ”¾ï¼ˆStep 2.1ï¼‰
- **ç¬¬ 4 ç‰ˆ**ï¼šæ¸…æ™°åº¦åˆ‡æ¢ï¼ˆStep 2.2ï¼‰

æ¯ä¸€æ­¥å®Œæˆåéƒ½æµ‹è¯•ï¼Œç¡®ä¿ç¨³å®šå†ç»§ç»­ä¸‹ä¸€æ­¥ã€‚









